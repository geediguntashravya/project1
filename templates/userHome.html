<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <title>Home</title>
    <style>

        .input-group-prepend {
            width: 100%;
            font-size: medium;
        }

        .searchform label {
            font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
            font-size: large;
            padding-top: 0;
            padding-left: 8px;
        }

        #pop {
            text-align: center;
        }

    </style>

    <script>


        // const email = "{{email}}"

        function search() {

            const request = new XMLHttpRequest();
            const value = document.querySelector('#Search').value;
            if (value.length === 0) {

                document.querySelector('#load').style.color = "red";
                document.querySelector('#load').innerHTML = "<br><b>You can't leave search bar empty<b>"
                return;
            }

            document.querySelector('#load').style.color = "black";

            request.open("POST" , "/api/search")
            //request.setRequestHeader("Content-Type", "application/json; charset=UTF-8");

            document.querySelector('#books').innerHTML = ""
            document.querySelector('#load').innerHTML = "<br><b>Loading...<b>"
            request.onload = () => {

                const response = JSON.parse(request.responseText);

                if (response.success) {
                    response.books.forEach(book => {

                    document.querySelector('#load').innerHTML = ""

                    let content = `

                            <div class="col-xs-12 col-sm-6 col-md-4 col-lg-4" style="margin-top: 4%;">
                                    <div class="card-body">
                                        <h5 class="card-title">Title</h5>
                                        <p class="card-text"><b>${book.title}</b></p>`+
                                        '<button type="submit" class="btn btn-primary" style="width: 150px;" name='+book.isbn+' onclick="book(this)">Review</button>'+
                                   '</div>'+
                            '</div>'

                            ;

                    document.querySelector('#books').innerHTML += content

                });

                } else {
                    document.querySelector('#load').style.color = "red";
                    document.querySelector('#load').innerHTML = "<br><b>No such book</b>";
                }
            }

            //const jsonData = JSON.stringify({"search" : value, "email" : email})
            const data=new FormData();
            data.append('key',value);
            request.send(data);
            return false;
        }


        function book(el){
            isbn=el.getAttribute("name")
            const request = new XMLHttpRequest();
            request.open("POST" , "/api/book")
            //alert(isbn)
            //request.setRequestHeader("Content-Type", "application/json; charset=UTF-8");

            request.onload = () =>{
                const response = JSON.parse(request.responseText);
                var displaydata = `
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col" class="bg-warning">Fields</th>
                            <th scope="col">Details</th>
                        </tr>

                        <tr>
                            <td class="bg-warning">ISBN No.</td>
                            <td class="table-light">${response.isbn}</td>
                            </tr>
                            <tr>
                                <td class="bg-warning">Title</td>
                                <td class="table-light">${response.title}</td>
                            </tr>
                            <tr>
                                <td class="bg-warning">Author</td>
                                <td class="table-light">${response.author}</td>
                            </tr>
                            <tr>
                                <td class="bg-warning">Publishing Year</td>
                                <td class="table-light">${response.year}</td>
                            </tr>
                        </tr>
                    </tbody>
                </table>
                <h4><pre class="tab1">Rate here</pre></h4>
                <div class="stars" class="form-check form-check-inline" class="sr-only">

                    <div class="rate">
                        <input class="star star-5 rating" id="star-5" type="radio" name="star" value=5 required>
                        <label class="star star-5" for="star-5">5</label>

                        <input class="star star-4 rating" id="star-4" type="radio" name="star" value=4 required>
                        <label class="star star-4" for="star-4">4</label>

                        <input class="star star-3 rating" id="star-3" type="radio" name="star" value=3 required>
                        <label class="star star-3" for="star-3">3</label>

                        <input class="star star-2 rating" id="star-2" type="radio" name="star" value=2 required>
                        <label class="star star-2" for="star-2">2</label>
                        
                        <input class="star star-1 rating" id="star-1" type="radio" name="star" value=1 required>
                        <label class="star star-1" for="star-1">1</label>
                    </div>
                    <br><br>
                    <div class="mb-3">
                    <label for="validationTextarea" style="color: black;font-size:larger;">Review here</label>
                    <textarea class="form-control is-invalid" name= "textarea" id="review" placeholder="Write review" required></textarea>
                        <br>`+

                    '<button type="submit" class="btn btn-primary btn-lg" name='+response.title+' onclick="takereview(this)">Submit</button>'+
                    '</div>'+

                '</div>'+
                '<p id="error" style = "color : red;"></p>'
                ;

                document.querySelector('#load').innerHTML += displaydata

            
        }
        const data=new FormData();
        data.append("isbn",isbn);
        request.send(data);
        return false;
    }

        // function is_required(isbn){
        //     console.log(isbn)
        //     var value = document.querySelector('#review').value;
        //     var ele = document.getElementsByName('star');
        //     var rating = ""
        //     for(i = 0; i < ele.length; i++) {
        //         if(ele[i].checked){rating=ele[i].value;}
        //     }
        //     if (rating.length!==0){
        //         if (value.length!==0){
        //             console.log(rating.length)
        //             console.log(value.length)
        //             document.querySelector('#error').innerHTML="";
        //             takereview(isbn);}
        //         else{
        //             document.querySelector('#error').innerHTML="enter both rating and review";}
        //     }
        //     else{
        //         document.querySelector('#error').innerHTML="enter both rating and review";}
        //     return false;
        // }

        function takereview(el){
            title=el.getAttribute("name")
            console.log(title)
            const request = new XMLHttpRequest();
            request.open("POST" , "/api/review")
            //request.setRequestHeader("Content-Type", "application/json; charset=UTF-8");

            request.onload = () =>{
                const response = JSON.parse(request.responseText);
                console.log(response)
                if (response.hasOwnProperty("error")){
                    var content = `<p style= "color:red;">${response.error}</p>`
                    document.querySelector('#load').innerHTML += content
                }
                else{
                    var disp=`<table class = "table">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">Rating</th>
                            <th scope="col" class="bg-warning">Review</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${response.rating}</td>
                            <td>${response.review} </td>
                        </tr>   
                    </tbody>
                </table>`
                    // var content = `<p>Rating : ${response.rating} </p>
                    // <p>Review : ${response.review} </p><br><br>`;
                    document.querySelector('#load').innerHTML += disp
                }
            }
            var value = document.querySelector('#review').value;
            var ele = document.getElementsByName('star');
            var rating = ""
            for(i = 0; i < ele.length; i++) {
                if(ele[i].checked){
                    rating=ele[i].value;
                }
            }
            //var data = JSON.stringify({"review" : value,"rating" : rating})
            const data=new FormData();
            data.append("rating",rating)
            console.log(rating)
            data.append("review",value)
            console.log(value)
            data.append("title",title)
            request.send(data);
            return false;
        }

    </script>
    <style>
        .rate {
                    float: left;
                    height: 40px;
                    padding: 0 10px;
                    align-content: center;
                    margin : auto auto auto 40%;
                }
                .rate:not(:checked) > input {
                    position:absolute;
                    top:-9999px;
                }
                .rate:not(:checked) > label {
                    float:right;
                    width:1em;
                    overflow:hidden;
                    white-space:nowrap;
                    cursor:pointer;
                    font-size:30px;
                    color:#ccc;
                }
                .rate:not(:checked) > label:before {
                    content: '★ ';
                }
                .rate > input:checked ~ label {
                    color: #ffc700;    
                }
                .rate:not(:checked) > label:hover,
                .rate:not(:checked) > label:hover ~ label {
                    color: #deb217;  
                }
                .rate > input:checked + label:hover,
                .rate > input:checked + label:hover ~ label,
                .rate > input:checked ~ label:hover,
                .rate > input:checked ~ label:hover ~ label,
                .rate > label:hover ~ input:checked ~ label {
                    color: #c59b08;
                }
    </style>
    
</head>
<header>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark sticky-top">
        <a class="navbar-brand" href="/account">Book Reviews</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="./">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout">Logout</a>
                </li>
            </ul>
        </div>
    </nav>
</header>

<body>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
        {% for msg in messages %}

            <div class="alert alert-warning alert-dismissible fade show" role="alert" id="pop">
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
              <strong>{{msg}}</strong>
            </div>

            <script>
              $(".alert").alert();
            </script>

        {% endfor %}
    {% endif %}
    {% endwith %}

    <span id="email" value={{email}}></span>
    <div class="container">

        <div class="row" style="margin-top: 5%;" id="search-tab">

            <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3"></div>

            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">

                <legend style="text-align: center;">Search Book</legend>

                <p>Search the book that you desire for</p>

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <input type="search" placeholder="" name="Search" class="form-control" id="Search"
                                aria-label="Search" aria-describedby="basic-addon1" required>
                                
                                <button type="submit" class="btn btn-primary" style="width: 150px;" onclick="search()">Search</button>
                        </div>
                    </div>
                    <p id="load" style="text-align: center;"></p>
                </div>
            <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3"></div>
        </div>
        

        <div class="row" id="books">
        </div>
    </div>
</body>

</html>

